import{H3Event as b,getRequestURL as j,getResponseHeaders as O,getRequestWebStream as F,getRequestHeaders as N,getResponseStatus as z,eventHandler as U}from"h3";import{getContext as V}from"unctx";import{AsyncLocalStorage as G}from"node:async_hooks";import{isPlainArray as J,isPlainObject as $,defer as Z,useRouter as f,ScriptOnce as _,pick as K,createControlledPromise as Q,RouterProvider as X,createMemoryHistory as Y,useRouterState as g,createRootRoute as ee,Outlet as te,ScrollRestoration as re,createFileRoute as ne,lazyRouteComponent as oe,lazyFn as se,createRouter as ae}from"@tanstack/react-router";import{jsxs as h,Fragment as y,jsx as i}from"react/jsx-runtime";import*as S from"react";import{createElement as q}from"react";import R from"jsesc";import ie from"tiny-invariant";import{Transform as ce,PassThrough as ue}from"node:stream";import{isbot as E}from"isbot";import v from"react-dom/server";import{Context as k}from"@tanstack/react-cross-context";import{createPortal as le}from"react-dom";function de(e,t,r){if(!r.router.isServer)return t;r.match.extracted=r.match.extracted||[];const n=r.match.extracted;return H(t,(o,s)=>{const c=o instanceof ReadableStream?"stream":o instanceof Promise?"promise":void 0;if(c){const u={dataType:e,type:c,path:s,id:n.length,value:o,matchIndex:r.match.index};if(n.push(u),c==="stream"){const[l,d]=o.tee();return u.streamState=ye({stream:d}),l}else Z(o)}return o})}function me(e){const t=f(),r=t.state.matches[e.matchIndex];if(!t.isServer)return null;const n=r.extracted,[a,o]=["__beforeLoadContext","loaderData"].map(s=>n?n.reduce((c,u)=>u.dataType!==s?T(c,["temp",...u.path],void 0):c,{temp:r[s]}).temp:r[s]);return h(y,{children:[a!==void 0||o!==void 0||n?.length?i(_,{children:`__TSR__.matches[${e.matchIndex}] = ${R({__beforeLoadContext:t.options.transformer.stringify(a),loaderData:t.options.transformer.stringify(o),extracted:n?Object.fromEntries(n.map(s=>[s.id,K(s,["type","path"])])):{}},{isScriptContext:!0,wrap:!0,json:!0})}; __TSR__.initMatch(${e.matchIndex})`}):null,n?n.map((s,c)=>s.type==="stream"?i(he,{entry:s},s.id):i(fe,{entry:s},s.id)):null]})}function H(e,t,r=[]){if(J(e))return e.map((a,o)=>H(a,t,[...r,`${o}`]));if($(e)){const a={};for(const o in e)a[o]=H(e[o],t,[...r,o]);return a}const n=t(e,r);return n!==e?n:e}function fe({entry:e}){return i("div",{className:"tsr-once",children:i(S.Suspense,{fallback:null,children:i(pe,{entry:e})})})}function pe({entry:e}){if(e.value.status==="pending")throw e.value;return i(_,{children:`__TSR__.matches[${e.matchIndex}].extracted[${e.id}].resolve(${R(e.value.data,{isScriptContext:!0,wrap:!0,json:!0})})`})}function he({entry:e}){return ie(e.streamState,"StreamState should be defined"),i(I,{streamState:e.streamState,children:t=>i(_,{children:t?`__TSR__.matches[${e.matchIndex}].extracted[${e.id}].value.controller.enqueue(new TextEncoder().encode(${R(t.toString(),{isScriptContext:!0,wrap:!0,json:!0})}))`:`__TSR__.matches[${e.matchIndex}].extracted[${e.id}].value.controller.close()`})})}function ye({stream:e}){const t={promises:[]},r=e.getReader(),n=a=>(t.promises[a]=Q(),r.read().then(({done:o,value:s})=>{if(o){t.promises[a].resolve(null),r.releaseLock();return}return t.promises[a].resolve(s),n(a+1)}));return n(0).catch(a=>{console.error("stream read error",a)}),t}function I({streamState:e,children:t,__index:r=0}){const n=e.promises[r];if(!n)return null;if(n.status==="pending")throw n;const a=n.value;return h(y,{children:[t(a),i("div",{className:"tsr-once",children:i(S.Suspense,{fallback:null,children:i(I,{streamState:e,__index:r+1,children:t})})})]})}function T(e,t,r){if(t.length===0)return r;const[n,...a]=t;return Array.isArray(e)?e.map((o,s)=>s===Number(n)?T(o,a,r):o):$(e)?{...e,[n]:T(e[n],a,r)}:e}function C(e){e.router.AfterEachMatch=me,e.router.serializer=n=>R(n,{isScriptContext:!0,wrap:!0,json:!0});const t=k.get("TanStackRouterHydrationContext",{}),r=S.useMemo(()=>{var n,a;return{router:e.router.dehydrate(),payload:(a=(n=e.router.options).dehydrate)==null?void 0:a.call(n)}},[e.router]);return i(t.Provider,{value:r,children:i(X,{router:e.router})})}function Se(e){let t;const r=A(e),n={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(r,{...n,body:e.node.req.body}):new Request(r,{...n,get body(){return t||(t=ve(e),t)}})}function ge(e){return e.web??={request:Se(e),url:A(e)},e.web.request}function _e(){return be()}const P=Symbol("$HTTPEvent");function Re(e){return typeof e=="object"&&(e instanceof b||e?.[P]instanceof b||e?.__is_event__===!0)}function x(e){return function(...t){let r=t[0];if(Re(r))t[0]=r instanceof b||r.__is_event__?r:r[P];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(r=_e(),!r)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(r)}return e(...t)}}const St=x(N),A=x(j),gt=x(z),xe=x(O),ve=x(F);function we(){return V("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:G})}function be(){return we().use().event}function He(e){return e instanceof Headers?new Headers(e):Array.isArray(e)?new Headers(e):typeof e=="object"?new Headers(e):new Headers}function M(...e){return e.reduce((t,r)=>{const n=He(r);for(const[a,o]of n.entries())t.set(a,o);return t},new Headers)}const Te="server-fn-return-type",Ee="server-fn-payload-type";function Ce({createRouter:e,getRouterManifest:t}){return r=>U(async n=>{const a=ge(n),o=new URL(a.url),s=o.href.replace(o.origin,""),c=Y({initialEntries:[s]}),u=e();u.serializeLoaderData=de,t&&(u.manifest=t()),u.update({history:c}),await u.load();const l=Me({event:n,router:u});return await r({request:a,router:u,responseHeaders:l})})}function Me(e){e.event.__tsrHeadersSent=!0;let t=M(xe(e.event),{"Content-Type":"text/html; charset=UTF-8"},...e.router.state.matches.map(n=>n.headers));const{redirect:r}=e.router.state;return r&&(t=M(t,r.headers,{Location:r.href})),[Te,Ee].forEach(n=>{t.delete(n)}),t}function $e(e){const t=L(()=>e.injectedHtml.map(r=>r()).join(""));return new ce({transform(r,n,a){t.transform(r,this.push.bind(this)).then(()=>a()).catch(o=>a(o))},flush(r){t.flush(this.push.bind(this)).then(()=>r()).catch(n=>r(n))}})}function qe(e){const t=L(()=>e.injectedHtml.map(n=>n()).join("")),r=new TextEncoder;return new TransformStream({transform(n,a){return t.transform(n,o=>(a.enqueue(r.encode(o)),!0))},flush(n){return t.flush(a=>(n.enqueue(a),!0))}})}const ke=/(<body)/,Ie=/(<\/body>)/,Pe=/(<\/html>)/,Ae=/(<\/[a-zA-Z][\w:.-]*?>)/g,Le=new TextDecoder;function L(e){let t=!1,r="",n="";return{async transform(a,o){const s=r+Le.decode(a),c=s.match(ke),u=s.match(Ie),l=s.match(Pe);try{if(c&&(t=!0),!t){o(s),r="";return}const d=e();if(u&&l&&u.index<l.index){const m=u.index+u[0].length,p=l.index+l[0].length,w=s.slice(0,m)+d+s.slice(m,p)+s.slice(p);o(w),r=""}else{let m,p=0;for(;(m=Ae.exec(s))!==null;)p=m.index+m[0].length;if(p>0){const w=s.slice(0,p)+d+n;o(w),r=s.slice(p)}else r=s,n+=d}}catch(d){throw console.error(d),d}},async flush(a){r&&a(r)}}}const Be=async({request:e,router:t,responseHeaders:r})=>{if(typeof v.renderToReadableStream=="function"){const n=await v.renderToReadableStream(i(C,{router:t}),{signal:e.signal,onError(s,c){console.error(s,c)}});E(e.headers.get("User-Agent"))&&await n.allReady;const o=[qe(t)].reduce((s,c)=>s.pipeThrough(c),n);return new Response(o,{status:t.state.statusCode,headers:r})}if(typeof v.renderToPipeableStream=="function"){const n=new ue,a=v.renderToPipeableStream(i(C,{router:t}),{...E(e.headers.get("User-Agent"))?{onAllReady(){a.pipe(n)}}:{onShellReady(){a.pipe(n)}},onShellError(c){throw c}}),s=[$e(t)].reduce((c,u)=>c.pipe(u),n);return new Response(s,{status:t.state.statusCode,headers:r})}throw new Error("No renderToReadableStream or renderToPipeableStream found in react-dom/server. Ensure you are using a version of react-dom that supports streaming.")},De=()=>({routes:{__root__:{filePath:"__root.tsx",children:["/"],preloads:["/_build/assets/client-_aV0kvq-.js","/_build/assets/client-CeGHaAMR.js"]},"/":{filePath:"index.tsx"}}});function We(e){return globalThis.MANIFEST[e]}function je(){const e=De(),t=e.routes.__root__=e.routes.__root__||{};t.assets=t.assets||[];const r=We("client");return t.assets.push({tag:"script",attrs:{src:r.inputs[r.handler]?.output.path,type:"module",async:!0,suppressHydrationWarning:!0}}),e}function Oe(){const e=je();return{...e,routes:Object.fromEntries(Object.entries(e.routes).map(([t,r])=>{const{preloads:n,assets:a}=r;return[t,{preloads:n,assets:a}]}))}}function B({tag:e,attrs:t,children:r}){switch(e){case"title":return i("title",{...t,suppressHydrationWarning:!0,children:r});case"meta":return i("meta",{...t,suppressHydrationWarning:!0});case"link":return i("link",{...t,suppressHydrationWarning:!0});case"style":return i("style",{...t,dangerouslySetInnerHTML:{__html:r}});case"script":return t&&t.src?i("script",{...t,suppressHydrationWarning:!0}):typeof r=="string"?i("script",{...t,dangerouslySetInnerHTML:{__html:r},suppressHydrationWarning:!0}):null;default:return null}}const Fe=()=>{const e=f(),t=g({select:o=>o.matches.map(s=>s.meta).filter(Boolean)}),r=S.useMemo(()=>{const o=[],s={};let c;return[...t].reverse().forEach(u=>{[...u].reverse().forEach(l=>{if(l.title)c||(c={tag:"title",children:l.title});else{if(l.name){if(s[l.name])return;s[l.name]=!0}o.push({tag:"meta",attrs:{...l}})}})}),c&&o.push(c),o.reverse(),o},[t]),n=g({select:o=>o.matches.map(s=>s.links).filter(Boolean).flat(1).map(s=>({tag:"link",attrs:{...s}}))}),a=g({select:o=>{const s=[];return o.matches.map(c=>e.looseRoutesById[c.routeId]).forEach(c=>{var u,l,d;return(d=(l=(u=e.manifest)==null?void 0:u.routes[c.id])==null?void 0:l.preloads)==null?void 0:d.filter(Boolean).forEach(m=>{s.push({tag:"link",attrs:{rel:"modulepreload",href:m}})})}),s}});return Je([...r,...a,...n],o=>JSON.stringify(o))},Ne=()=>{const e=f(),t=Fe(),r=S.useContext(k.get("TanStackRouterHydrationContext",{}));return h(y,{children:[i("meta",{name:"tsr-meta"}),t.map((n,a)=>q(B,{...n,key:`tsr-meta-${JSON.stringify(n)}`})),h(y,{children:[i(_,{log:!1,children:`
__TSR__ = {
  matches: [],
  streamedValues: {},
  initMatch: (index) => {
    Object.entries(__TSR__.matches[index].extracted).forEach(([id, ex]) => {
      if (ex.type === 'stream') {
        let controller;
        ex.value = new ReadableStream({
          start(c) { controller = c; }
        })
        ex.value.controller = controller
      } else if (ex.type === 'promise') {
        let r, j
        ex.value = new Promise((r_, j_) => { r = r_, j = j_ })
        ex.resolve = r; ex.reject = j
      }
    })
  },
  cleanScripts: () => {
    document.querySelectorAll('.tsr-once').forEach((el) => {
      el.remove()
    })
  },
}`}),i(_,{children:`__TSR__.dehydrated = ${R(e.options.transformer.stringify(r),{isScriptContext:!0,wrap:!0,json:!0})}`})]}),i("meta",{name:"/tsr-meta"})]})},ze=({children:e})=>{const t=f(),r=Ne(),[n,a]=S.useState(!1);S[typeof document<"u"?"useLayoutEffect":"useEffect"](()=>{if(typeof document>"u")return;const s=document.head.querySelector('meta[name="tsr-meta"]'),c=document.head.querySelector('meta[name="/tsr-meta"]');let u=s?.nextElementSibling;for(;u&&u!==c;){const l=u.nextElementSibling;u.remove(),u=l}s?.remove(),c?.remove(),a(!0)},[]);const o=h(y,{children:[r,e]});return t.isServer?o:n?le(o,document.head):null};function Ue({children:e,...t}){return f().isServer?i("html",{children:e}):i(y,{children:e})}function Ve({children:e,...t}){return f().isServer?i("head",{children:e}):e}function Ge({children:e,...t}){return f().isServer?i("body",{children:i("div",{id:"root",children:e})}):e}function Je(e,t){const r=new Set;return e.filter(n=>{const a=t(n);return r.has(a)?!1:(r.add(a),!0)})}const Ze=()=>{const e=f(),t=g({select:a=>{const o=[];return a.matches.map(s=>e.looseRoutesById[s.routeId]).forEach(s=>{var c,u,l;return(l=(u=(c=e.manifest)==null?void 0:c.routes[s.id])==null?void 0:u.assets)==null?void 0:l.filter(d=>d.tag==="script").forEach(d=>{o.push({tag:"script",attrs:d.attrs,children:d.children})})}),o}}),{scripts:r}=g({select:a=>({scripts:a.matches.map(o=>o.scripts).filter(Boolean).flat(1).map(({children:o,...s})=>({tag:"script",attrs:{...s,suppressHydrationWarning:!0},children:o}))})}),n=[...r,...t];return i(y,{children:n.map((a,o)=>q(B,{...a,key:`tsr-scripts-${a.tag}-${o}`}))})},D=ee({meta:()=>[{charSet:"utf-8"},{name:"viewport",content:"width=device-width, initial-scale=1"},{title:"TanStack Start Starter"}],component:Ke});function Ke(){return i(Qe,{children:i(te,{})})}function Qe({children:e}){return h(Ue,{children:[i(Ve,{children:i(ze,{})}),h(Ge,{children:[e,i(re,{}),i(Ze,{})]})]})}const Xe=()=>import("./index-VUlDrTel.js"),Ye=()=>import("./index-VUlDrTel.js"),W=ne("/")({component:oe(Ye,"component",()=>W.ssr),loader:se(Xe,"loader")}),et=W.update({id:"/",path:"/",getParentRoute:()=>D}),tt={IndexRoute:et},rt=D._addFileChildren(tt)._addFileTypes();function nt(){return ae({routeTree:rt})}const _t=Ce({createRouter:nt,getRouterManifest:Oe})(Be);export{W as R,Te as a,gt as b,be as c,St as d,We as g,_t as h,Ee as s,ge as t};
